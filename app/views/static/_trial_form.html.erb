<% form_id  = "email-upload-#{rand(1_000_000)}" %>
<% box_id   = "#{form_id}-box" %>
<% name_id  = "#{form_id}-name" %>
<% email_id = "#{form_id}-email" %>
<% team_id  = "#{form_id}-team" %>

<form id="<%= form_id %>" class="flex flex-col items-center" novalidate>
  <div id="<%= box_id %>" class="border border-gray-200 rounded-xl shadow bg-white p-6 <%= form_width_class %>">
    <div class="text-[16px]">
      <div class="mb-4">
        This is the only form. Your first batch of emails go out <span class="font-semibold">next Monday</span>.
      </div>

      <div class="mb-4">
        <span class="font-semibold">3-month free trial</span>. No cards, demos, or marketing spam.
      </div>

      <div class="mb-4">
        Copy/paste your whole org once. If an engineer stops replying for a few weeks, their weekly drills get paused automatically (with an invite to re-engage).
      </div>

      <div class="mb-4">
        You'll know how many seats you need by the end. I'll only reach out if your team's engaging with the <a href="https://gist.github.com/jacob-comer/4dee4c8e5c0123d8aac9c65ea9f03b54" class="text-blue-600 hover:text-blue-700 font-medium hover:underline hover:underline-offset-4 decoration-1 transition" target="_blank">GPT loop</a>. Otherwise it just fades away and wipes your data.
      </div>

      <div class="mb-8">
        Here are the docs for <a href="/security" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium hover:underline hover:underline-offset-4 decoration-1 transition">security</a> and <a href="/billing" target="_blank" class="text-blue-600 hover:text-blue-700 font-medium hover:underline hover:underline-offset-4 decoration-1 transition">billing</a>. Approvals will be quick.
      </div>
    </div>

    <div>
      <label for="<%= name_id %>" class="block font-medium mb-1 tracking-normal">Name</label>
      <input type="text" id="<%= name_id %>" class="block w-full border border-neutral-300 shadow-sm rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-indigo-100 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 text-sm" />
    </div>

    <div class="mt-6">
      <label for="<%= email_id %>" class="block font-medium mb-1 tracking-normal">Your Email</label>
      <input type="email" id="<%= email_id %>" class="block w-full border border-neutral-300 shadow-sm rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-indigo-100 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 text-sm" />
    </div>

    <div class="mt-6">
      <label for="<%= team_id %>" class="block font-medium tracking-normal mb-1">Team's Emails</label>
      <textarea id="<%= team_id %>" rows="4" class="block w-full border border-neutral-300 shadow-sm rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-indigo-100 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 text-sm" placeholder="Any format works. Email support@replicate.info to make changes later."></textarea>
    </div>

    <div class="text-xs text-gray-500 mt-4">
      By submitting, you agree to the <a href="/terms" class="text-blue-500 hover:underline">Terms</a> and <a href="/privacy" class="text-blue-500 hover:underline">Privacy Policy</a>.
    </div>

    <!-- CTA -->
    <div class="mt-6 w-full sm:mt-8">
      <button type="submit"
              class="inline-flex w-full items-center justify-center rounded-lg bg-slate-700 px-5 py-3 text-lg font-semibold text-white shadow-sm transition hover:bg-slate-800 hover:shadow-md active:bg-slate-900 sm:w-auto focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400">
        <svg class="mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M10.75 3.5l5.75 5.75-5.75 5.75v-3.5H4.5v-4.5h6.25v-3.5z"/>
        </svg>
        Begin Coaching
      </button>
    </div>
  </div>
</form>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("#<%= form_id %>");
    if (!form) return;

    const box   = document.getElementById("<%= box_id %>");
    const nameI = document.getElementById("<%= name_id %>");
    const mailI = document.getElementById("<%= email_id %>");
    const teamI = document.getElementById("<%= team_id %>");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name  = nameI?.value?.trim();
      const email = mailI?.value?.trim();
      const engineerEmails = teamI?.value?.trim();

      if (!name || !email || !engineerEmails) {
        alert("Please fill out all fields.");
        return;
      }

      // Optional: disable button to prevent double submit
      const btn = form.querySelector('button[type="submit"]');
      btn?.setAttribute("disabled", "disabled");

      try {
        const response = await fetch("/organizations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content
          },
          body: JSON.stringify({ name, email, engineer_emails: engineerEmails })
        });

        if (!response.ok) throw new Error("Request failed");

        // Keep the white box container; replace its contents only
        box.innerHTML = `
          <div class="text-center text-md text-gray-800 py-6">
            <span class="font-medium">You're in. The first email goes out Monday.</span>
            <div class="mt-4">
              <a href="/coaching" class="text-blue-600 hover:text-blue-700 hover:underline hover:underline-offset-4 decoration-1 transition">
                Test your production instincts.&nbsp;&rarr;
              </a>
            </div>
          </div>
        `;
      } catch (error) {
        alert("Something went wrong. Please try again.");
        btn?.removeAttribute("disabled");
      }
    });
  });
</script>