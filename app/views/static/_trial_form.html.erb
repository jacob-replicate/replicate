<% form_id  = "email-upload-#{rand(1_000_000)}" %>
<% box_id   = "#{form_id}-box" %>
<% name_id  = "#{form_id}-name" %>
<% email_id = "#{form_id}-email" %>
<% team_id  = "#{form_id}-team" %>

<form id="<%= form_id %>" novalidate>
  <div id="<%= box_id %>" class="border-2 rounded-lg bg-white <%= extra_form_container_classes %>">
    <div class="p-5">
      <div class="text-xl tracking-tight font-medium mb-4">
        Next Steps
      </div>
      <div class="text-[16px]">
        <div class="mb-4">
          You get the first SEV immediately. <span class="block mt-4 md:inline md:mt-0"><span class="font-semibold">No demos or setup</span>. 100% async.</span>
        </div>

        <div class="mb-8">
          It emails a new infra puzzle every Monday, which you'll scramble to fix in <span class="font-semibold">private threads</span>. The more you think out loud, the better GPT can uncover blind spots. <span class="block mt-4 hidden md:inline md:mt-0">Here's what the <a href="/intro-email-mobile-first.png" class="md:hidden text-blue-600 hover:underline font-semibold" target="_blank" tabindex="-1">first email</a><a href="/intro-email-desktop-first.png" class="hidden md:inline text-blue-600 hover:underline font-semibold" target="_blank" tabindex="-1">first email</a> might look like.</span>
        </div>
      </div>

      <div>
        <label for="<%= name_id %>" class="block font-semibold mb-1 tracking-normal text-[16px]">Name <span class="text-red-600">*</span></label>
        <input type="text" id="<%= name_id %>" class="block w-full border border-neutral-300 shadow-sm rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-indigo-100 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 text-sm" />
      </div>

      <div class="mt-8">
        <label for="<%= email_id %>" class="block font-semibold text-[16px] mb-1 tracking-normal">Your Email <span class="text-red-600">*</span></label>
        <input type="email" id="<%= email_id %>" class="block w-full border border-neutral-300 shadow-sm rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-indigo-100 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 text-sm" />
      </div>

      <div class="mt-8">
        <label for="<%= team_id %>" class="block font-semibold text-[16px] tracking-normal mb-1">Team's Emails</label>
        <div class="text-[13px] mb-2">
          You <span class="md:hidden">could also</span><span class="hidden md:inline">can</span>
          <a href="/sev" target="_blank" tabindex="-1" class="inline text-blue-700 font-semibold hover:text-blue-700 hover:underline hover:underline-offset-4 decoration-1 transition items-center">
            try the product
          </a>
          solo for awhile, and
          <a href="mailto:support@replicate.info" tabindex="-1" class="inline text-blue-700 font-semibold hover:text-blue-700 hover:underline hover:underline-offset-4 decoration-1 transition items-center">
            email support
          </a>
          to add people later.
        </div>
        <textarea id="<%= team_id %>" rows="4" class="block w-full border border-neutral-300 shadow-sm rounded-md bg-white px-3 py-1.5 text-gray-900 outline-1 -outline-offset-1 outline-indigo-100 placeholder:text-gray-400 focus:outline-2 focus:-outline-offset-2 focus:outline-indigo-600 text-sm" placeholder="Use any format you want (commas, newlines, semicolons, spaces, etc)."></textarea>


        <div class="mt-3 text-[13px]" style="line-height: 1.3rem">
          <span class="font-semibold">3-month free trial</span>. Engineers get <span class="font-semibold">unsubscribed</span> after 3 weeks of inactivity.
          <% msa_month_name = 2.months.from_now.strftime("%B") %>
          I'll send a pre-signed <a href="/replicate-msa-dpa.pdf" class="text-blue-600 hover:underline font-semibold" target="_blank" tabindex="-1">MSA/DPA</a> in <%= msa_month_name %> if you're still here.<span class="hidden md:inline font-semibold"> No marketing emails.</span>
        </div>
      </div>

      <div class="mt-6 w-full">
        <button type="submit" class="shadow-md inline-flex w-full items-center justify-center rounded-lg bg-slate-700 px-5 py-3 text-lg font-semibold text-white transition hover:bg-slate-800 hover:shadow-md active:bg-slate-900 sm:w-auto focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-400">
          Start Weekly Drills
        </button>
      </div>

      <div class="text-xs text-gray-400 mt-6">
        By submitting, you agree to the <a href="/terms" tabindex="-1" class="text-blue-400 hover:underline">Terms</a> and <a href="/privacy" tabindex="-1" class="text-blue-400 hover:underline">Privacy Policy</a>.
      </div>
    </div>
  </div>
</form>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("#<%= form_id %>");
    if (!form) return;

    const box   = document.getElementById("<%= box_id %>");
    const nameI = document.getElementById("<%= name_id %>");
    const mailI = document.getElementById("<%= email_id %>");
    const teamI = document.getElementById("<%= team_id %>");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name  = nameI?.value?.trim();
      const email = mailI?.value?.trim();
      const engineerEmails = teamI?.value?.trim();

      if (!name || !email) {
        alert("Please fill out all required fields.");
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn?.setAttribute("disabled", "disabled");

      try {
        const response = await fetch("/organizations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content
          },
          body: JSON.stringify({ name, email, engineer_emails: engineerEmails })
        });

        if (!response.ok) throw new Error("Request failed");

        box.innerHTML = `
          <div class="text-center text-base text-gray-800 p-6">
            <span class="font-medium">You're in.</span> Go check your email. Everyone gets their own copy.
          </div>
        `;
      } catch (error) {
        alert("Something went wrong. Please try again.");
        btn?.removeAttribute("disabled");
      }
    });
  });
</script>