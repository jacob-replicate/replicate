<% form_id  = "email-upload-#{rand(1_000_000)}" %>
<% box_id   = "#{form_id}-box" %>
<% name_id  = "#{form_id}-name" %>
<% email_id = "#{form_id}-email" %>
<% team_id  = "#{form_id}-team" %>

<form id="<%= form_id %>" novalidate>
  <div id="<%= box_id %>" class="border rounded-lg bg-white dark:bg-zinc-800/50 border-zinc-200 dark:border-zinc-700">
    <div class="p-5">
      <div class="text-[23px] tracking-tight mb-4 inline-block text-zinc-800 dark:text-zinc-100">
        <span class="font-semibold">Try it for a quarter</span>.
      </div>

      <div class="mt-2">
        <label for="<%= email_id %>" class="block text-[16px] mb-1 tracking-tight text-zinc-800 dark:text-zinc-100">Email Address&nbsp;<span class="text-red-600 dark:text-red-400">*</span></label>
        <div class="text-[14px] mb-2 text-zinc-600 dark:text-zinc-300">
          <span class="font-semibold inline-block bg-yellow-200 dark:bg-yellow-600/30 dark:text-yellow-200 px-1">Auto-unsubscribed</span> after 3 inactive weeks.
        </div>
        <input type="email" id="<%= email_id %>" class="block w-full border border-zinc-200 dark:border-zinc-600 shadow-sm rounded-md bg-white dark:bg-zinc-700/50 px-3 py-1.5 text-zinc-800 dark:text-zinc-100 placeholder:text-zinc-400 dark:placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-violet-500 dark:focus:ring-violet-400 text-sm" />
      </div>

      <div class="mt-[8px]" id="show-team-input-cta">
        <a onclick="document.getElementById('team-input').classList.remove('hidden'); this.parentElement.classList.add('hidden');" class="inline text-violet-600 dark:text-violet-400 font-medium text-sm hover:text-violet-700 dark:hover:text-violet-300 hover:underline hover:underline-offset-4 decoration-1 items-center cursor-pointer">
          + Add your team's emails
        </a>
        <span class="text-sm text-zinc-500 dark:text-zinc-400">(optional)</span>
      </div>

      <div class="mt-8 hidden" id="team-input">
        <label for="<%= team_id %>" class="block font-semibold text-[17px] tracking-normal text-zinc-800 dark:text-zinc-100">Team's Emails</label>
        <textarea id="<%= team_id %>" rows="4" class="mt-2 block w-full border border-zinc-200 dark:border-zinc-600 shadow-sm rounded-md bg-white dark:bg-zinc-700/50 px-3 py-1.5 text-zinc-800 dark:text-zinc-100 placeholder:text-zinc-400 dark:placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-violet-500 dark:focus:ring-violet-400 text-sm" placeholder="Use any format you want (commas, newlines, semicolons, spaces, etc)."></textarea>
      </div>

      <div class="mt-4 lg:mt-[32px] w-full">
        <button type="submit" class="shadow inline-flex w-full items-center justify-center rounded-md bg-violet-600 dark:bg-violet-500 px-4 py-3 text-lg font-semibold text-white hover:bg-violet-700 dark:hover:bg-violet-600 hover:shadow-md active:bg-violet-800 dark:active:bg-violet-700 sm:w-auto focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-400">
          Start Weekly Drills
        </button>
      </div>

      <div class="text-xs text-zinc-400 dark:text-zinc-500 mt-[20px]">
        Here are the <a href="/terms" tabindex="-1" class="text-violet-500 dark:text-violet-400 hover:underline">Terms</a> + <a href="/privacy" tabindex="-1" class="text-violet-500 dark:text-violet-400 hover:underline">Privacy Policy</a><span class="hidden md:inline"> you're agreeing to.</span>
      </div>
    </div>
  </div>
</form>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("#<%= form_id %>");
    if (!form) return;

    const box   = document.getElementById("<%= box_id %>");
    const mailI = document.getElementById("<%= email_id %>");
    const teamI = document.getElementById("<%= team_id %>");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = mailI?.value?.trim();
      const engineerEmails = teamI?.value?.trim();

      if (!email) {
        alert("You need to provide an email address.");
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn?.setAttribute("disabled", "disabled");

      try {
        const response = await fetch("/organizations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content
          },
          body: JSON.stringify({ name, email, engineer_emails: engineerEmails })
        });

        if (!response.ok) throw new Error("Request failed");

        box.innerHTML = `
          <div class="text-center text-base text-gray-800 p-6">
            <span class="font-medium">You're in.</span> Go check your email. Everyone gets their own copy.
          </div>
        `;
      } catch (error) {
        alert("Something went wrong. Please try again.");
        btn?.removeAttribute("disabled");
      }
    });
  });
</script>