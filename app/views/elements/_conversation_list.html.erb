<%
  children = element.elements.includes(:conversation)
  total_count = children.count
  visited_count = children.where.not(conversation_id: nil).count
  progress_pct = total_count > 0 ? (visited_count.to_f / total_count * 100).round : 0
  all_done = visited_count == total_count && total_count > 0
%>

<div class="mt-6 mb-2 flex items-center justify-between">
  <h3 class="text-[15px] font-medium text-zinc-700 dark:text-zinc-300">
    <%= element.context["name"] %>
  </h3>
  <% if total_count > 0 %>
    <div class="flex items-center gap-2">
      <div class="w-16 h-1.5 bg-zinc-200 dark:bg-zinc-700 rounded-full overflow-hidden">
        <div class="h-full <%= all_done ? 'bg-emerald-500' : 'bg-blue-500' %> rounded-full transition-all" style="width: <%= progress_pct %>%"></div>
      </div>
      <span class="text-[11px] tabular-nums <%= all_done ? 'text-emerald-600 dark:text-emerald-400 font-medium' : 'text-zinc-400 dark:text-zinc-500' %>"><%= visited_count %>/<%= total_count %></span>
    </div>
  <% end %>
</div>

<div class="space-y-px">
  <% element.elements.includes(:conversation).order(Arel.sql("conversation_id IS NULL DESC"), updated_at: :desc).each_with_index do |row, index| %>
    <% conversation = row.conversation_id %>
    <% visited = conversation.present? %>
    <% href = element_path(row) %>

    <a href="<%= href %>" class="topic-link group flex items-center gap-3 py-2 pr-2 transition-colors">
      <%# Left accent: blue when unvisited, gray when visited %>
      <div class="w-0.5 h-5 rounded-full <%= visited ? 'bg-zinc-300 dark:bg-zinc-600' : 'bg-blue-500 dark:bg-blue-400' %> transition-colors"></div>

      <span class="flex-1 text-[14px] leading-relaxed <%= visited ? 'text-purple-600 dark:text-purple-400' : 'text-blue-600 dark:text-blue-400 group-hover:underline underline-offset-8' %> transition-colors">
        <%= row.context["name"].to_s.html_safe %>
      </span>

      <% if visited %>
        <svg class="w-4 h-4 text-emerald-400 dark:text-emerald-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
      <% else %>
        <span class="text-zinc-400 dark:text-zinc-600 opacity-0 group-hover:opacity-100 transition-opacity">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </span>
      <% end %>
    </a>
  <% end %>
</div>