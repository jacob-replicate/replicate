<style>
  /* --- Markdown styling for chat bubbles --- */
  .message-body {
    font-size: 1.05rem;
    line-height: 1.625;
  }

  .message-body p {
    margin-top: 1.1rem;
  }

  .message-body p:first-child {
    margin-top: 0;
  }

  .message-body ul,
  .message-body ol {
    padding-left: 2rem;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .message-body ul {
    list-style-type: disc;
  }

  .message-body ol {
    list-style-type: decimal;
  }

  .message-body li {
    margin-bottom: 1.5rem;
  }

  .message-body strong {
    font-weight: 600;
  }

  .message-body hr {
    padding: 0;
    margin: 10px 0;
    opacity: 0.7;
  }

  .message-body a {
    text-decoration: underline;
  }

  .message-body hr:first-child {
    display: none;
  }

  .message-body hr:last-child {
    display: none;
  }

  .message-body code {
    background-color: #242424;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: white;
  }

  .message-body pre code {
    display: block;
    color: white;
    padding: 1rem;
    border-radius: 0.25rem;
    overflow-x: auto;
    font-size: 0.875rem;
  }
</style>

<% user_message_classes = "bg-gray-100 rounded-2xl shadow px-4 py-3 mb-3" %>
<% base_message_classes = "break-words message-body" %>

<div class="flex flex-col mt-6">
  <!-- Chat history -->
  <div class="flex-1 rounded-md border border-gray-200 mb-4">
    <div id="conversation" class="p-4">
      <% @conversation.messages.order(created_at: :asc).each do |m| %>
        <div class="flex <%= m.user_generated ? 'justify-end' : 'justify-start' %>">
          <% message_classes = "#{base_message_classes} #{user_message_classes if m.user_generated}" %>
          <div class="<%= message_classes %>"><%= m.content.html_safe %></div>
        </div>
      <% end %>
    </div>
    <div class="text-sm bg-gray-100 py-2 px-4 border-t border-gray-200">
      <div class="flex justify-between w-full items-center">
        <div class="">
          Sent<span class="md:inline hidden"> automatically</span> every Monday
        </div>
        <div class="justify-end">
          <a href="/coaching" class="text-blue-600 hover:text-blue-700 font-medium hover:underline hover:underline-offset-4 decoration-1 transition">
            <% if @conversation.context["conversation_type"] == "landing_demo" %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 0 1-.657.643 48.39 48.39 0 0 1-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 0 1-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 0 0-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 0 1-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 0 0 .657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 0 1-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 0 0 5.427-.63 48.05 48.05 0 0 0 .582-4.717.532.532 0 0 0-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 0 0 .658-.663 48.422 48.422 0 0 0-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 0 1-.61-.58v0Z" />
              </svg>

              Try your first puzzle
            <% else %>
              <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Try another puzzle
              </div>
            <% end %>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="pb-4">
    <div class="flex items-center gap-2">
      <textarea id="message-input" placeholder="Type a messageâ€¦" class="w-full border border-gray-200 rounded-lg p-2 resize-none disabled:opacity-50 disabled:cursor-not-allowed" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
      <button id="send-button" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 ml-auto h-full disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
    </div>

    <% if params[:require_tos] %>
      <div id="terms-container" class="mt-3 text-xs text-gray-500">
        By submitting, you agree to the <a href="/terms" class="text-blue-500 hover:underline">Terms</a> and <a href="/privacy" class="text-blue-500 hover:underline">Privacy Policy</a>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const conversationId   = "<%= @conversation.id %>";
    const textarea         = document.getElementById("message-input");
    const sendButton       = document.getElementById("send-button");
    const conversationEl   = document.getElementById("conversation");
    const tosWrapper       = document.getElementById("terms-container");

    const SCROLL_THRESHOLD = 120;
    let userManuallyScrolled = false;

    function atBottom() {
      return (
        conversationEl.scrollHeight -
        conversationEl.scrollTop -
        conversationEl.clientHeight
      ) <= SCROLL_THRESHOLD;
    }

    function scrollToBottomIfWanted() {
      if (!userManuallyScrolled && atBottom()) {
        conversationEl.scrollTop = conversationEl.scrollHeight;
      }
    }

    conversationEl.addEventListener("scroll", () => {
      userManuallyScrolled = !atBottom();
    });

    let aiIsTyping         = false;
    let loadingEl          = null;

    function setInputEnabled(enabled) {
      textarea.disabled = !enabled;
      sendButton.disabled = !enabled;
      sendButton.classList.toggle("opacity-50", !enabled);
      sendButton.classList.toggle("cursor-not-allowed", !enabled);
    }

    function sendMessage() {
      const message = textarea.value.trim();
      if (!message || aiIsTyping) return;

      aiIsTyping = true;
      setInputEnabled(false);

      if (tosWrapper) {
        tosWrapper.remove();
      }

      fetch("/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ conversation_id: conversationId, content: message })
      });

      textarea.value = "";
      textarea.style.height = "auto";
      textarea.focus();
    }

    sendButton.addEventListener("click", sendMessage);
    textarea.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    window.consumer.subscriptions.create(
      { channel: "ConversationChannel", id: conversationId },
      {
        received(data) {
          const isUser     = data.user_generated;
          const isLoading  = data.type === "loading";
          const isDone     = data.type === "done";

          if (isLoading) {
            if (!loadingEl) {
              loadingEl = document.createElement("div");
              loadingEl.className = "flex justify-start";
              let dotInterval;

              loadingEl.innerHTML = `
                <div class="message-body bg-white border border-gray-200 text-gray-500 rounded-2xl px-4 py-3 mb-2 italic">
                  Thinking<span id="loading-dots">.</span>
                </div>
              `;

              dotInterval = setInterval(() => {
                const dots = document.getElementById("loading-dots");
                if (!dots) return;
                dots.textContent = dots.textContent.length >= 3 ? "." : dots.textContent + ".";
              }, 500);
              conversationEl.appendChild(loadingEl);
              scrollToBottomIfWanted();
            }
            aiIsTyping = true;
            setInputEnabled(false);
            return;
          }

          if (isDone) {
            if (loadingEl) {
              loadingEl.remove();
              loadingEl = null;
            }

            aiIsTyping           = false;
            userManuallyScrolled = false;
            setInputEnabled(true);
            scrollToBottomIfWanted();
            return;
          }

          if (data.message) {
            if (loadingEl) {
              loadingEl.remove();
              loadingEl = null;
            }

            const wrapper = document.createElement("div");
            wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

            const bubble = document.createElement("div");
            bubble.className = isUser ? "<%= "#{base_message_classes} #{user_message_classes}" %>" : "<%= base_message_classes %>";
            bubble.innerHTML = data.message;

            wrapper.appendChild(bubble);
            conversationEl.appendChild(wrapper);
            scrollToBottomIfWanted();
          }
        }
      }
    );
  });
</script>