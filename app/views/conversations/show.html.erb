<script src="/marked.min.js"></script>

<style>
  .message-body {
    font-size: 1rem;
    line-height: 1.625;
  }

  .message-body p {
    margin-top: 1.1rem;
  }

  .message-body p:first-child {
    margin-top: 0;
  }

  .message-body ul,
  .message-body ol {
    padding-left: 2rem;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .message-body ul {
    list-style-type: disc;
  }

  .message-body ol {
    list-style-type: decimal;
  }

  .message-body li {
    margin-bottom: 1.5rem;
  }

  .message-body strong {
    font-weight: 600;
  }

  .message-body a {
    text-decoration: underline;
  }

  .message-body code {
    background-color: #1f2937;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }

  .message-body pre code {
    display: block;
    background-color: #111827;
    padding: 1rem;
    border-radius: 0.25rem;
    overflow-x: auto;
    font-size: 0.875rem;
  }
</style>

<% user_message_classes = "bg-gray-100 rounded-2xl shadow px-4 py-3" %>
<% base_message_classes = "break-words message-body" %>

<div class="flex-1 overflow-hidden mt-6">
  <div class="flex flex-col h-full">

    <!-- Chat history -->
    <div id="conversation" class="flex-1 overflow-y-auto border border-gray-200 mb-4 p-4 rounded-lg space-y-4">
      <% @conversation.messages.each do |m| %>
        <div class="flex <%= m.user.present? ? 'justify-end' : 'justify-start' %>">
          <% message_classes = "#{base_message_classes} #{user_message_classes if m.user.present?}" %>
          <div class="<%= message_classes %>"><%= markdown(m.content) %></div>
        </div>
      <% end %>
    </div>

    <!-- Input area -->
    <div class="flex items-center gap-2">
      <textarea id="message-input"
                placeholder="Type a messageâ€¦"
                class="w-full border border-gray-200 rounded-lg p-2 resize-none
                       disabled:opacity-50 disabled:cursor-not-allowed"
                rows="1"
                oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
      <button id="send-button"
              class="bg-slate-500 text-white px-4 py-2 rounded-lg hover:bg-slate-600
                     ml-auto h-full disabled:opacity-50 disabled:cursor-not-allowed">
        Send
      </button>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const conversationId   = "<%= @conversation.id %>";
    const textarea         = document.getElementById("message-input");
    const sendButton       = document.getElementById("send-button");
    const conversationEl   = document.getElementById("conversation");

    const SCROLL_THRESHOLD = 120;
    let userManuallyScrolled = false;

    function atBottom() {
      return (
        conversationEl.scrollHeight -
        conversationEl.scrollTop -
        conversationEl.clientHeight
      ) <= SCROLL_THRESHOLD;
    }

    function scrollToBottomIfWanted() {
      if (atBottom()) {
        conversationEl.scrollTop = conversationEl.scrollHeight;
      }
    }

    conversationEl.addEventListener("scroll", () => {
      userManuallyScrolled = !atBottom();
    });

    let aiIsTyping         = false;
    let streamingMessageEl = null;

    function setInputEnabled(enabled) {
      textarea.disabled = !enabled;
      sendButton.disabled = !enabled;
      sendButton.classList.toggle("opacity-50", !enabled);
      sendButton.classList.toggle("cursor-not-allowed", !enabled);
    }

    function sendMessage() {
      const message = textarea.value.trim();
      if (!message || aiIsTyping) return;

      aiIsTyping = true;
      setInputEnabled(false);

      fetch("/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ conversation_id: conversationId, content: message })
      });

      textarea.value = "";
      textarea.style.height = "auto";
      textarea.focus();
    }

    sendButton.addEventListener("click", sendMessage);
    textarea.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    window.consumer.subscriptions.create(
      { channel: "ConversationChannel", id: conversationId },
      {
        received(data) {
          const isUser  = data.user_submitted;
          const isStream = data.type === "stream";
          const isDone   = data.type === "done";

          if (isStream && !aiIsTyping) {
            aiIsTyping = true;
            setInputEnabled(false);
          }

          if (isStream) {
            if (!streamingMessageEl) {
              const wrapper = document.createElement("div");
              wrapper.className = "flex justify-start";

              streamingMessageEl = document.createElement("div");

              streamingMessageEl.className = isUser ? "<%= "#{base_message_classes} #{user_message_classes}" %>" : "<%= base_message_classes %>";
              streamingMessageEl.markdownBuffer = "";

              wrapper.appendChild(streamingMessageEl);
              conversationEl.appendChild(wrapper);
            }

            streamingMessageEl.markdownBuffer += data.message;
            streamingMessageEl.innerHTML = marked.parse(streamingMessageEl.markdownBuffer);
            if (!userManuallyScrolled) scrollToBottomIfWanted();
            return;
          }

          if (isDone) {
            streamingMessageEl   = null;
            aiIsTyping           = false;
            userManuallyScrolled = false;
            setInputEnabled(true);
            scrollToBottomIfWanted();
            return;
          }

          if (data.message) {
            const wrapper = document.createElement("div");
            wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

            const bubble = document.createElement("div");
            bubble.className = isUser ? "<%= "#{base_message_classes} #{user_message_classes}" %>" : "<%= base_message_classes %>";
            bubble.innerHTML = marked.parse(data.message);

            wrapper.appendChild(bubble);
            conversationEl.appendChild(wrapper);
            if (!userManuallyScrolled) scrollToBottomIfWanted();
          }
        }
      }
    );
  });
</script>