<style>
  .message-body {
    line-height: 1.6;
    margin-bottom: 0.5rem;
    word-break: break-word;
    overflow-wrap: break-word;
  }

  .prompt-output {
    margin-top: 15px;
  }

  .message-body p {
    margin-top: 10px;
  }

  .message-body p:first-child {
    margin-top: 0;
  }

  .message-body ul,
  .message-body ol {
    padding-left: 2rem;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .message-body ul {
    list-style-type: disc;
  }

  .message-body ol {
    list-style-type: decimal;
  }

  .message-body li {
    margin-bottom: 1.5rem;
  }

  .message-body strong {
    font-weight: 600;
  }

  .message-body hr {
    padding: 0;
    margin: 18px 0 0 0;
    opacity: 0.7;
  }

  .message-body a {
    text-decoration: underline;
  }

  .message-body code {
    background-color: #242424;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: white;
  }

  .message-body pre code {
    display: block;
    color: white;
    padding: 1rem;
    border-radius: 0.25rem;
    overflow-x: auto;
    font-size: 0.875rem;
  }
</style>

<% user_message_classes = "bg-neutral-100 rounded-2xl shadow px-4 py-3 max-w-2xl md:max-w-xl" %>
<% base_message_classes = "break-words message-body" %>

<div class="flex flex-col mt-10">
  <!-- Chat history -->
  <div class="flex-1 rounded-md">
    <div id="conversation"
         data-base-class="<%= base_message_classes %>"
         data-user-class="<%= user_message_classes %>">
      <% @conversation.messages.order(created_at: :asc).each_with_index do |m, i| %>
        <div class="flex <%= i > 0 ? "mt-4" : "" %> <%= m.user_generated ? 'justify-end' : 'justify-start' %>">
          <% message_classes = "#{base_message_classes} #{user_message_classes if m.user_generated}" %>
          <div class="<%= message_classes %>"><%= m.content.html_safe %></div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="pb-4 mt-2">
    <div class="flex items-center gap-2">
      <textarea id="message-input" placeholder="Type a messageâ€¦" class="w-full border border-gray-200 rounded-lg p-2 resize-none disabled:opacity-50 disabled:cursor-not-allowed" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
      <button id="send-button" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 ml-auto h-full disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
    </div>

    <% if params[:require_tos] %>
      <div id="terms-container" class="mt-3 text-xs text-gray-500">
        By submitting, you agree to the <a href="/terms" class="text-blue-500 hover:underline">Terms</a> and <a href="/privacy" class="text-blue-500 hover:underline">Privacy Policy</a>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Email form submission
    const conversationId = "<%= @conversation.id %>";
    const textarea = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");
    const conversationEl = document.getElementById("conversation");
    const tosWrapper = document.getElementById("terms-container");

    const SCROLL_THRESHOLD = 120;
    let userManuallyScrolled = false;

    function atBottom() {
      return (
        conversationEl.scrollHeight -
        conversationEl.scrollTop -
        conversationEl.clientHeight
      ) <= SCROLL_THRESHOLD;
    }

    function scrollToBottomIfWanted() {
      if (!userManuallyScrolled && atBottom()) {
        conversationEl.scrollTop = conversationEl.scrollHeight;
      }
    }

    conversationEl.addEventListener("scroll", () => {
      userManuallyScrolled = !atBottom();
    });

    let aiIsTyping = false;
    let loadingEl = null;
    let activeStreamContainer = null;
    let dotInterval;

    function setInputEnabled(enabled) {
      if(textarea) {
        textarea.disabled = !enabled;
        sendButton.disabled = !enabled;
        sendButton.classList.toggle("opacity-50", !enabled);
        sendButton.classList.toggle("cursor-not-allowed", !enabled);
        textarea.focus();
        scrollToBottomIfWanted();
      }
    }

    function sendMessage() {
      const message = textarea.value.trim();
      if (!message || aiIsTyping) return;

      aiIsTyping = true;
      setInputEnabled(false);

      if (tosWrapper) {
        tosWrapper.remove();
      }

      fetch("/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ conversation_id: conversationId, content: message })
      });

      textarea.value = "";
      textarea.style.height = "auto";
      textarea.focus();
    }

    if(textarea) {
      sendButton.addEventListener("click", sendMessage);
      textarea.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    let messageQueue = {};
    let expectedSequence = <%= @conversation.next_message_sequence %>;

    function tryFlushQueue() {
      while (messageQueue[expectedSequence]) {
        const data = messageQueue[expectedSequence];
        renderMessage(data);
        delete messageQueue[expectedSequence];
        expectedSequence++;
      }
    }

    function renderMessage(data) {
      const isUser = data.user_generated;
      const isLoading = data.type === "loading";
      const isDone = data.type === "done";

      if (data.type === "show_cta") {
        const cta = document.getElementById("cta");
        if (cta) cta.classList.remove("hidden");
        return;
      }

      if (isLoading) {
        if (!loadingEl) {
          loadingEl = document.createElement("div");
          loadingEl.className = `mb-3 flex ${isUser ? "justify-end" : "justify-start"}`;
          const bubbleClass = "bg-white border border-gray-200 text-gray-500";
          loadingEl.innerHTML = `
        <div class="message-body ${bubbleClass} rounded-xl px-4 py-3 italic mt-2">
          Thinking<span id="loading-dots">.</span>
        </div>
      `;
          dotInterval = setInterval(() => {
            const dots = document.getElementById("loading-dots");
            if (!dots) return;
            dots.textContent = dots.textContent.length >= 3 ? "." : dots.textContent + ".";
          }, 500);
          conversationEl.appendChild(loadingEl);
          scrollToBottomIfWanted();
        }
        aiIsTyping = true;
        setInputEnabled(false);
        return;
      }

      if (isDone) {
        if (loadingEl) {
          loadingEl.remove();
          loadingEl = null;
        }
        if (dotInterval) {
          clearInterval(dotInterval);
          dotInterval = null;
        }
        aiIsTyping = false;
        activeStreamContainer = null;
        setInputEnabled(true);
        scrollToBottomIfWanted();
        return;
      }

      if (data.message) {
        const baseClass = conversationEl.dataset.baseClass;
        const userClass = conversationEl.dataset.userClass;
        const finalClass = isUser ? `${baseClass} ${userClass}` : baseClass;

        if (!activeStreamContainer || data.sequence === 0) {
          const wrapper = document.createElement("div");
          wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

          activeStreamContainer = document.createElement("div");
          let classes = finalClass;
          if (data.sequence && data.sequence > 0) classes += " mt-4";

          activeStreamContainer.className = classes;
          wrapper.appendChild(activeStreamContainer);
          conversationEl.appendChild(wrapper);
        }

        activeStreamContainer.innerHTML += data.message;
        scrollToBottomIfWanted();
      }
    }

    window.consumer.subscriptions.create(
      { channel: "ConversationChannel", id: conversationId },
      {
        received(data) {
          console.log(data);
          if (data.sequence !== undefined) {
            messageQueue[data.sequence] = data;
            tryFlushQueue();
          } else {
            renderMessage(data); // still support non-sequenced messages
          }
        }
      }
    );
  });
</script>