<script src="/marked.min.js"></script>

<style>
  /* --- Markdown styling for chat bubbles --- */
  .message-body {
    font-size: 1.05rem;
    line-height: 1.625;
  }

  .message-body p {
    margin-top: 1.1rem;
  }

  .message-body p:first-child {
    margin-top: 0;
  }

  .message-body ul,
  .message-body ol {
    padding-left: 2rem;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .message-body ul {
    list-style-type: disc;
  }

  .message-body ol {
    list-style-type: decimal;
  }

  .message-body li {
    margin-bottom: 1.5rem;
  }

  .message-body strong {
    font-weight: 600;
  }

  .message-body hr {
    padding: 0;
    margin: 10px 0;
    opacity: 0.7;
  }

  .message-body a {
    text-decoration: underline;
  }

  .message-body hr:first-child {
    display: none;
  }

  .message-body hr:last-child {
    display: none;
  }

  .message-body code {
    background-color: #242424;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    color: white;
  }

  .message-body pre code {
    display: block;
    color: white;
    padding: 1rem;
    border-radius: 0.25rem;
    overflow-x: auto;
    font-size: 0.875rem;
  }
</style>

<%# ----------------------------------------------------------------------- %>
<%#  View constants %>
<% user_message_classes = "bg-gray-100 rounded-2xl shadow px-4 py-3 mb-4" %>
<% base_message_classes = "break-words message-body" %>

<%# ----------------------------------------------------------------------- %>
<%#  Main container: fill viewport height, keep CTA + input visible %>
<div class="flex flex-col mt-6">
  <!-- Chat history -->
  <div id="conversation" class="flex-1 md:border border-gray-200 mb-4 md:p-4 md:rounded-lg space-y-4">
    <% @conversation.messages.order(created_at: :asc).each do |m| %>
      <div class="flex <%= m.user_generated ? 'justify-end' : 'justify-start' %>">
        <% message_classes = "#{base_message_classes} #{user_message_classes if m.user_generated}" %>
        <div class="<%= message_classes %>"><%= markdown(m.content) %></div>
      </div>
    <% end %>
  </div>

  <div class="pb-4">
    <div class="flex items-center gap-2">
      <textarea id="message-input" placeholder="Type a messageâ€¦" class="w-full border border-gray-200 rounded-lg p-2 resize-none disabled:opacity-50 disabled:cursor-not-allowed" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
      <button id="send-button" class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 ml-auto h-full disabled:opacity-50 disabled:cursor-not-allowed">Send</button>
    </div>

    <% if params[:require_tos] %>
      <div id="terms-container" class="mt-3 text-xs text-gray-500">
        By submitting, you agree to the <a href="/terms" class="text-blue-500 hover:underline">Terms</a> and <a href="/privacy" class="text-blue-500 hover:underline">Privacy Policy</a>
      </div>
    <% end %>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const conversationId   = "<%= @conversation.id %>";
    const textarea         = document.getElementById("message-input");
    const sendButton       = document.getElementById("send-button");
    const conversationEl   = document.getElementById("conversation");
    const tosWrapper       = document.getElementById("terms-container");

    const SCROLL_THRESHOLD = 120;
    let userManuallyScrolled = false;

    function atBottom() {
      return (
        conversationEl.scrollHeight -
        conversationEl.scrollTop -
        conversationEl.clientHeight
      ) <= SCROLL_THRESHOLD;
    }

    function scrollToBottomIfWanted() {
      if (!userManuallyScrolled && atBottom()) {
        conversationEl.scrollTop = conversationEl.scrollHeight;
      }
    }

    conversationEl.addEventListener("scroll", () => {
      userManuallyScrolled = !atBottom();
    });

    let aiIsTyping         = false;
    let streamingMessageEl = null;
    let loadingEl          = null;

    function setInputEnabled(enabled) {
      textarea.disabled = !enabled;
      sendButton.disabled = !enabled;
      sendButton.classList.toggle("opacity-50", !enabled);
      sendButton.classList.toggle("cursor-not-allowed", !enabled);
    }

    function sendMessage() {
      const message = textarea.value.trim();
      if (!message || aiIsTyping) return;

      aiIsTyping = true;
      setInputEnabled(false);

      if (tosWrapper) {
        tosWrapper.remove();
      }

      fetch("/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ conversation_id: conversationId, content: message })
      });

      textarea.value = "";
      textarea.style.height = "auto";
      textarea.focus();
    }

    sendButton.addEventListener("click", sendMessage);
    textarea.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    window.consumer.subscriptions.create(
      { channel: "ConversationChannel", id: conversationId },
      {
        received(data) {
          const isUser     = data.user_generated;
          const isStream   = data.type === "stream";
          const isLoading  = data.type === "loading";
          const isDone     = data.type === "done";

          if (isLoading) {
            if (!loadingEl) {
              loadingEl = document.createElement("div");
              loadingEl.className = "flex justify-start";
              let dotInterval;

              loadingEl.innerHTML = `
                <div class="message-body bg-white border border-gray-200 text-gray-500 rounded-2xl px-4 py-3 mb-4 italic">
                  Thinking<span id="loading-dots">.</span>
                </div>
              `;

              dotInterval = setInterval(() => {
                const dots = document.getElementById("loading-dots");
                if (!dots) return;
                dots.textContent = dots.textContent.length >= 3 ? "." : dots.textContent + ".";
              }, 500);
              conversationEl.appendChild(loadingEl);
              scrollToBottomIfWanted();
            }
            return;
          }

          if (isStream && !aiIsTyping) {
            aiIsTyping = true;
            setInputEnabled(false);
          }

          if (isStream) {
            if (loadingEl) {
              loadingEl.remove();
              loadingEl = null;
              clearInterval(dotInterval);
            }

            if (!streamingMessageEl) {
              const wrapper = document.createElement("div");
              wrapper.className = "flex justify-start";

              streamingMessageEl = document.createElement("div");
              streamingMessageEl.className = isUser ? "<%= "#{base_message_classes} #{user_message_classes}" %>" : "<%= base_message_classes %>";
              streamingMessageEl.markdownBuffer = "";

              wrapper.appendChild(streamingMessageEl);
              conversationEl.appendChild(wrapper);
            }

            streamingMessageEl.markdownBuffer += data.message;
            let markdown = streamingMessageEl.markdownBuffer
              .replace("<pre>", "")
              .replace("</pre>", "")
              .replace(/(?<!\n)(---)/g, '\n$1')
              .replace(/\.(?=- )/g, '.\n');
            if (markdown.length > 10) {
              streamingMessageEl.innerHTML = marked.parse(markdown);
            }

            scrollToBottomIfWanted();
            return;
          }

          if (isDone) {
            if (loadingEl) {
              loadingEl.remove();
              loadingEl = null;
            }

            streamingMessageEl   = null;
            aiIsTyping           = false;
            userManuallyScrolled = false;
            setInputEnabled(true);
            scrollToBottomIfWanted();
            return;
          }

          if (data.message) {
            if (loadingEl) {
              loadingEl.remove();
              loadingEl = null;
            }

            const wrapper = document.createElement("div");
            wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

            const bubble = document.createElement("div");
            bubble.className = isUser ? "<%= "#{base_message_classes} #{user_message_classes}" %>" : "<%= base_message_classes %>";
            bubble.innerHTML = marked.parse(data.message);

            wrapper.appendChild(bubble);
            conversationEl.appendChild(wrapper);
            scrollToBottomIfWanted();
          }
        }
      }
    );
  });
</script>