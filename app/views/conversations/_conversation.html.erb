<% user_message_classes = "bg-neutral-100 rounded-2xl shadow px-4 py-3 max-w-2xl md:max-w-xl" %>
<% base_message_classes = "break-words message-body" %>

<div class="flex flex-col">
  <div class="flex-1 rounded-lg bg-white p-4 border border-gray-200 shadow text-[16px]">
    <div id="conversation" data-base-class="<%= base_message_classes %>" data-user-class="<%= user_message_classes %>">
      <% @conversation.messages.order(created_at: :asc).each_with_index do |m, i| %>
        <div class="flex <%= i > 0 ? "mt-6" : "" %> <%= m.user_generated ? 'justify-end' : 'justify-start' %>">
          <% message_classes = "#{base_message_classes} #{user_message_classes if m.user_generated}" %>
          <div class="<%= message_classes %>"><%= m.content.gsub(HINT_LINK, "").gsub(ANOTHER_HINT_LINK, "").gsub(FINAL_HINT_LINK, "").html_safe %></div>
        </div>
      <% end %>
    </div>

    <div class="flex items-center gap-2 mt-4">
      <textarea id="message-input" placeholder="Test your instincts..." class="w-full border border-gray-200 rounded-lg p-2 resize-none disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"></textarea>
    </div>
  </div>
</div>

<div id="email-subscribe-box" class="hidden mt-6 border-2 border-gray-400 bg-gray-100 rounded-lg p-3 text-[16px] transition-opacity duration-1000">
  <form id="email-subscribe-form" class="lg:flex lg:items-center lg:justify-between">
    <div class="lg:mr-6">
      <%= params[:action] == "index" ? "Want SEV drills via email?&nbsp;".html_safe : "" %><span class="block mt-4 lg:inline lg:mt-0">You get <span class="font-semibold">auto-unsubscribed</span> after 3 inactive weeks.</span>
    </div>

    <div id="email-subscribe-controls" class="flex flex-col mt-4 space-y-4 lg:mt-0 lg:flex-row lg:items-center lg:space-y-0 lg:space-x-2 lg:w-auto">
      <input id="subscribe-email" type="email" class="border rounded border-gray-300 p-2 lg:w-[200px] text-sm" placeholder="Email Address" required />
      <button type="submit" class="bg-indigo-600 text-white px-4 py-1.5 rounded-md tracking-tight hover:bg-indigo-700 transition-all lg:w-auto">
        <span class="hidden lg:inline text-sm">Subscribe</span>
        <span class="lg:hidden">Start Weekly Drills</span>
      </button>
    </div>
  </form>
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Email form submission
    const conversationId = "<%= @conversation.id %>";
    const textarea = document.getElementById("message-input");
    const conversationEl = document.getElementById("conversation");
    const tosWrapper = document.getElementById("terms-container");
    window.mcEnabled = true;
    let messageQueue = {};
    let expectedSequence = <%= @conversation.next_message_sequence %>;

    function pastFirstMessage() {
      return expectedSequence > 6;
    }

    function scrollToBottom() {
      if(pastFirstMessage()) {
        const input = document.getElementById('message-input');
        if (input) {
          const rect = input.getBoundingClientRect();
          const isVisible = rect.bottom <= window.innerHeight && rect.top >= 0;

          if (!isVisible) {
            const offset = 200; // how much space you want *below* the input
            const scrollY = window.scrollY;
            const inputBottom = rect.bottom + scrollY;
            const scrollTarget = inputBottom - window.innerHeight + offset;
            window.scrollTo({ top: scrollTarget, behavior: 'smooth' });
          }
        }
      }
    }

    let aiIsTyping = false;
    let loadingEl = null;
    let activeStreamContainer = null;
    let dotInterval;

    function setInputEnabled(enabled) {
      if(textarea) {
        textarea.disabled = !enabled;
        if(pastFirstMessage() || <%= params[:action] != 'index' %> || window.innerWidth >= 1024) {
          textarea.focus();
        }
        scrollToBottom();
      }

      if(expectedSequence > 50 && enabled) {
        const emailBox = document.getElementById("email-subscribe-box");
        if (emailBox && emailBox.classList.contains("hidden")) {
          /*
            emailBox.classList.remove("hidden");
            setTimeout(() => {
              const emailBox = document.getElementById("email-subscribe-box");
              emailBox.style.opacity = "1";
            }, 2000); // slight delay to ensure transition
          */
        }
      }

    }

    window.generateHint = function() {
      sendMessage("Give me a hint");
    }

    window.generateAnotherHint = function() {
      sendMessage("Give me another hint");
    }

    window.generateFinalHint = function() {
      sendMessage("What am I missing here?");
    }

    function sendMessage(message, suggested) {
      message ||= textarea.value.trim();
      if (!message || aiIsTyping) return;

      if(suggested === undefined && window.mcEnabled) {
        const lastMC = conversationEl.querySelectorAll(".multiple-choice-options");
        if (lastMC.length > 0) {
          lastMC[lastMC.length - 1].remove();
        }
        window.mcEnabled = false;
      }

      if (typeof message === 'string' && message.includes("isTrusted")) {
        if(message != "Give me a hint") {
          textarea.value = "";
        }

        textarea.style.height = "auto";
        textarea.focus();
        return;
      }

      aiIsTyping = true;
      setInputEnabled(false);

      if (tosWrapper) {
        tosWrapper.remove();
      }

      fetch("/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ conversation_id: conversationId, content: message, suggested: suggested })
      });

      if(message != "Give me a hint") {
        textarea.value = "";
      }

      textarea.style.height = "auto";
      textarea.focus();
    }

    if(textarea) {
      textarea.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }


    function tryFlushQueue() {
      while (messageQueue[expectedSequence]) {
        const data = messageQueue[expectedSequence];
        renderMessage(data);
        delete messageQueue[expectedSequence];
        expectedSequence++;
      }
    }

    function renderMessage(data) {
      const isUser = data.user_generated;
      const isLoading = data.type === "loading";
      const isMultipleChoice = data.type === "multiple_choice";
      const isDone = data.type === "done";

      if (isLoading) {
        if (!loadingEl) {
          loadingEl = document.createElement("div");
          loadingEl.className = `mt-3 flex ${isUser ? "justify-end" : "justify-start"}`;
          const bubbleClass = "bg-yellow-100 border border-yellow-200 text-gray-700";
          loadingEl.innerHTML = `
        <div class="message-body ${bubbleClass} rounded-xl px-3 py-2 text-sm mt-2">
          Thinking<span id="loading-dots">.</span>
        </div>
      `;
          dotInterval = setInterval(() => {
            const dots = document.getElementById("loading-dots");
            if (!dots) return;
            dots.textContent = dots.textContent.length >= 3 ? "." : dots.textContent + ".";
          }, 500);
          conversationEl.appendChild(loadingEl);
          scrollToBottom();
        }
        aiIsTyping = true;
        setInputEnabled(false);
        return;
      }

      if (isDone) {
        if (loadingEl) {
          loadingEl.remove();
          loadingEl = null;
        }
        if (dotInterval) {
          clearInterval(dotInterval);
          dotInterval = null;
        }
        aiIsTyping = false;
        activeStreamContainer = null;
        setInputEnabled(true);
        scrollToBottom();
        return;
      }

      if (data.message) {
        const baseClass = conversationEl.dataset.baseClass;
        const userClass = conversationEl.dataset.userClass;
        const finalClass = isUser ? `${baseClass} ${userClass}` : baseClass;

        if(isMultipleChoice) {
          const options = Array.isArray(data.message) ? data.message : [];
          const uniqueGroupId = "choice_group_" + Math.random().toString(36).substring(2, 10);
          const container = document.createElement("div");
          container.className = "mt-4 mb-6 flex flex-col gap-2 multiple-choice-options";

          options.forEach((opt, i) => {
            const option = document.createElement("label");
            option.className = "text-sm flex items-center p-2 border border-indigo-300 bg-indigo-50 rounded-lg hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer transition";

            const input = document.createElement("input");
            input.type = "radio";
            input.name = uniqueGroupId;
            input.onclick = function() {
              sendMessage(opt, true);
              const radios = document.querySelectorAll(`input[name="${uniqueGroupId}"]`);
              radios.forEach((r) => {
                r.disabled = true;
                r.removeEventListener("change", arguments.callee);

                const parentLabel = r.closest("label");

                if (r === input) {
                  parentLabel.classList.remove(
                    "bg-indigo-50",
                    "border-indigo-300",
                    "hover:border-indigo-400"
                  );
                  parentLabel.classList.add(
                    "bg-indigo-100",
                    "border-indigo-500",
                    "ring-2",
                    "ring-indigo-200"
                  );
                } else {
                  parentLabel.classList.add("opacity-50");
                  parentLabel.classList.remove("cursor-pointer", "hover:border-indigo-400");
                }
              });
            }
            input.className = "h-4 w-4 text-indigo-600 border-gray-400 focus:ring-indigo-500";
            input.value = i;

            const span = document.createElement("span");
            span.className = "ml-2";
            span.innerHTML = opt;

            option.appendChild(input);
            option.appendChild(span);
            container.appendChild(option);
          });

          conversationEl.appendChild(container);

          return;
        } else if (!activeStreamContainer || data.sequence === 0) {
          const wrapper = document.createElement("div");
          wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

          activeStreamContainer = document.createElement("div");
          let classes = finalClass;
          if (data.sequence && data.sequence > 1) classes += " mt-6";

          activeStreamContainer.className = classes;
          wrapper.appendChild(activeStreamContainer);
          conversationEl.appendChild(wrapper);
        }

        document.querySelectorAll(".hint-link").forEach((link) => { link.remove(); });

        activeStreamContainer.innerHTML += data.message;
        scrollToBottom();
      }
    }

    window.consumer.subscriptions.create(
      { channel: "ConversationChannel", id: conversationId },
      {
        received(data) {
          if (data.sequence !== undefined) {
            messageQueue[data.sequence] = data;
            tryFlushQueue();
          } else {
            renderMessage(data); // still support non-sequenced messages
          }
        }
      }
    );
  });
</script>


<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("email-subscribe-form");
    if (!form) return;

    const box = document.getElementById("email-subscribe-box");
    const emailInput = document.getElementById("subscribe-email");
    const controls = document.getElementById("email-subscribe-controls");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = emailInput?.value?.trim();
      if (!email) {
        alert("Please enter a valid email address.");
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn?.setAttribute("disabled", "disabled");

      try {
        const response = await fetch("/organizations", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content
          },
          body: JSON.stringify({ email })
        });

        if (!response.ok) throw new Error("Request failed");

        // Swap controls with a checkmark
        controls.innerHTML = `
          <div class="text-green-600 font-semibold flex items-center space-x-2">
            <span class="text-xl">âœ…</span>
            <span>You're subscribed</span>
          </div>
        `;

        setTimeout(function() {
          const emailBox = document.getElementById("email-subscribe-box");
          emailBox.style.opacity = "0";

          const textarea = document.getElementById("message-input");
          textarea.focus();
          setTimeout(() => { emailBox.classList.add("hidden"); }, 1000); // Match your CSS transition duration (e.g. 1000ms)
        }, 3000); // Hide after 3 seconds
      } catch (error) {
        alert("Something went wrong. Please try again.");
        btn?.removeAttribute("disabled");
      }
    });
  });
</script>

<script>
  const fpPromise = import('https://openfpcdn.io/fingerprintjs/v4').then(FingerprintJS => FingerprintJS.load())
  fpPromise.then(fp => fp.get()).then(result => {
    window.visitorId = result.visitorId

    const response = fetch("/conversations/<%= @conversation.id %>", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.content
      },
      body: JSON.stringify({ fingerprint: window.visitorId });
    });
  })
</script>