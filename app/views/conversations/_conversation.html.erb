<% system_message_classes = "w-full" %>
<% user_message_classes = "bg-zinc-100 dark:bg-zinc-700/50 rounded-xl border border-zinc-200 dark:border-zinc-600 px-4 py-3 max-w-2xl md:max-w-xl" %>
<% base_message_classes = "break-words message-body" %>

<div class="flex flex-col">
  <div class="flex-1 rounded-lg bg-white dark:bg-zinc-800/50 p-4 border border-zinc-200 dark:border-zinc-700/40 shadow-sm text-[16px]">
    <div id="conversation" class="relative text-zinc-800 dark:text-zinc-100" data-base-class="<%= base_message_classes %>" data-user-class="<%= user_message_classes %>">
      <% @conversation.messages.order(created_at: :asc).each_with_index do |m, i| %>
        <div class="flex <%= i > 0 ? "mt-8" : "" %> <%= m.user_generated ? 'justify-end' : 'justify-start' %>">
          <% message_classes = "#{base_message_classes} #{system_message_classes unless m.user_generated} #{user_message_classes if m.user_generated}" %>
          <div class="<%= message_classes %>"><%= m.content.gsub(HINT_LINK, "").gsub(ANOTHER_HINT_LINK, "").gsub(FINAL_HINT_LINK, "").html_safe %></div>
        </div>
      <% end %>
    </div>

    <div class="flex gap-3 mt-4 items-stretch" id="user-input">
      <div class="flex-1 flex">
        <textarea
          id="message-input"
          placeholder="<%= @conversation.variant == "incident" ? "Test your instincts..." : "What's on your mind?" %>"
          class="flex-1 border border-zinc-200 dark:border-zinc-600 bg-white dark:bg-zinc-700/50 text-zinc-800 dark:text-zinc-100 rounded-lg p-2 resize-none disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-violet-500 dark:focus:ring-violet-400 focus:border-violet-500 dark:focus:border-violet-400 placeholder:text-zinc-400 dark:placeholder:text-zinc-500"
          rows="1"
          maxlength="2000"
          oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';"
        ></textarea>
        </div>
      </div>


    <% conversation_ids = Conversation.where(ip_address: request.remote_ip).pluck(:id) %>
    <% total_messages = Message.user.where(conversation_id: conversation_ids).where("created_at > ?", 1.week.ago) %>
    <% unless total_messages.count > 5 %>
      <div id="terms-container" class="mt-4 text-xs text-zinc-500 dark:text-zinc-400">
        By submitting, you agree to the <a href="/terms" class="text-violet-600 dark:text-violet-400 hover:underline">Terms</a> and <a href="/privacy" class="text-violet-600 dark:text-violet-400 hover:underline">Privacy Policy</a>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const conversationId = "<%= @conversation.id %>";
    const textarea = document.getElementById("message-input");
    const conversationEl = document.getElementById("conversation");
    const tosWrapper = document.getElementById("terms-container");
    let messageQueue = {};
    let expectedSequence = <%= @conversation.next_message_sequence %>;
    window.sentMessages = false;

    function pastFirstMessage() {
      return expectedSequence > 6;
    }

    function scrollToBottom() {
      if (pastFirstMessage()) {
        const conversation = document.getElementById('conversation');
        if (!conversation) return;

        // Find all messages, grab the last non-user one
        const messages = conversation.querySelectorAll('.message-body.w-full');
        if (messages.length === 0) return;

        const lastMessage = messages[messages.length - 1];
        const rect = lastMessage.getBoundingClientRect();
        const scrollY = window.scrollY;
        const targetY = rect.top + scrollY - 100; // offset so itâ€™s not glued to top

        window.scrollTo({ top: targetY, behavior: 'smooth' });
      }
    }

    let aiIsTyping = false;
    let loadingEl = null;
    let activeStreamContainer = null;
    let dotInterval;

    function setInputEnabled(enabled) {
      if(textarea) {
        textarea.disabled = !enabled;
        textarea.focus({ preventScroll: true });
      }
    }

    window.generateHint = function() {
      sendMessage("Give me a hint")
    }

    window.generateAnotherHint = function() {
      sendMessage("Give me another hint")
    }

    window.generateFinalHint = function() {
      sendMessage("What am I missing here?")
    }

    function sendMessage(message, suggested) {
      window.sentMessages = true;
      let terms = document.getElementById("terms-container")
      if(terms) {
        terms.classList.add("hidden");
      }
      message ||= textarea.value.trim();
      if (!message || aiIsTyping) return;

      if (suggested === undefined) {
        const lastMCs = conversationEl.querySelectorAll(".multiple-choice-options");
        if (lastMCs.length > 0) {
          const lastMC = lastMCs[lastMCs.length - 1];
          const radios = lastMC.querySelectorAll("input[type='radio']");
          const anySelected = Array.from(radios).some(r => r.checked);

          if (!anySelected) {
            lastMC.remove();
          }
        }
      }

      if (typeof message === 'string' && message.includes("isTrusted")) {
        if(message != "Give me a hint") {
          textarea.value = "";
        }

        textarea.style.height = "auto";
        textarea.focus();
        return;
      }

      aiIsTyping = true;
      setInputEnabled(false);

      if (tosWrapper) {
        tosWrapper.remove();
      }

      fetch("/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ conversation_id: conversationId, content: message, suggested: suggested })
      });

      if(message != "Give me a hint" && message != "Give me another hint" && message != "What am I missing here?") {
        textarea.value = "";
      }

      textarea.style.height = "auto";
      textarea.focus();
    }

    if(textarea) {
      textarea.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }


    function tryFlushQueue() {
      while (messageQueue[expectedSequence]) {
        const data = messageQueue[expectedSequence];
        renderMessage(data);
        delete messageQueue[expectedSequence];
        expectedSequence++;
      }
    }

    function renderMessage(data) {
      const isUser = data.user_generated;
      const isLoading = data.type === "loading";
      const isMultipleChoice = data.type === "multiple_choice";
      const isArticleSuggestions = data.type === "article_suggestions";
      const isTitle = data.type === "title";
      const isDone = data.type === "done";

      if (isLoading) {
        if (!loadingEl) {
          loadingEl = document.createElement("div");
          loadingEl.className = `mt-1 flex ${isUser ? "justify-end" : "justify-start"}`;
          const bubbleClass = "bg-yellow-100 border border-yellow-200 text-gray-700 dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-300";
          loadingEl.innerHTML = `
        <div class="message-body ${bubbleClass} rounded-xl px-3 py-2 text-sm mt-2">
          Thinking<span id="loading-dots">.</span>
        </div>
      `;
          dotInterval = setInterval(() => {
            const dots = document.getElementById("loading-dots");
            if (!dots) return;
            dots.textContent = dots.textContent.length >= 3 ? "." : dots.textContent + ".";
          }, 500);
          conversationEl.appendChild(loadingEl);
        }
        aiIsTyping = true;
        setInputEnabled(false);
        return;
      }

      if (isDone) {
        if (loadingEl) {
          loadingEl.remove();
          loadingEl = null;
        }
        if (dotInterval) {
          clearInterval(dotInterval);
          dotInterval = null;
        }
        aiIsTyping = false;
        activeStreamContainer = null;
        setInputEnabled(true);
        scrollToBottom();
        return;
      }

      if (data.message) {
        const baseClass = conversationEl.dataset.baseClass;
        const userClass = conversationEl.dataset.userClass;
        const finalClass = isUser ? `${baseClass} ${userClass}` : `${baseClass} w-full`;

        if(isArticleSuggestions) {
          activeStreamContainer = null;
          conversationEl.insertAdjacentHTML("beforeend", "<div>" + data.message + "</div>");
          scrollToBottom();
          return;
        } else if(isTitle) {
          document.title = data.message;
          return;
        } else if(isMultipleChoice) {
          const options = Array.isArray(data.message) ? data.message : [];
          const uniqueGroupId = "choice_group_" + Math.random().toString(36).substring(2, 10);

// Outer wrapper
          const container = document.createElement("div");
          container.className = "mt-2 mb-4";

// Parent card
          const parentCard = document.createElement("div");
          const isDark = document.documentElement.classList.contains('dark');
          parentCard.className = isDark
            ? "flex flex-col bg-zinc-800 border border-zinc-600 shadow-sm rounded-lg overflow-hidden"
            : "flex flex-col bg-gray-50 border border-gray-200 shadow-sm rounded-lg overflow-hidden";

          options.forEach((opt, i) => {
            const option = document.createElement("label");
            option.className = isDark
              ? "text-[15px] flex items-center p-[12px] cursor-pointer text-zinc-100 hover:bg-zinc-700"
              : "text-[15px] flex items-center p-[12px] cursor-pointer hover:bg-indigo-50";

            // Add bottom border except last item
            if (i < options.length - 1) {
              option.classList.add("border-b");
              option.classList.add(isDark ? "border-zinc-600" : "border-gray-200");
            }

            const input = document.createElement("input");
            input.type = "radio";
            input.name = uniqueGroupId;
            input.className = isDark
              ? "h-4 w-4 text-violet-500 border-zinc-500 bg-zinc-700 focus:ring-violet-400"
              : "h-4 w-4 text-indigo-600 border-gray-400 focus:ring-indigo-500";
            input.value = i;

            input.onclick = function () {
              sendMessage(opt, true);

              const radios = document.querySelectorAll(`input[name="${uniqueGroupId}"]`);
              radios.forEach((r) => {
                r.disabled = true;
                r.removeEventListener("change", arguments.callee);

                const parentLabel = r.closest("label");

                if (r === input) {
                  parentLabel.classList.remove(isDark ? "hover:bg-zinc-700" : "hover:bg-indigo-50");
                  parentLabel.classList.add(isDark ? "bg-zinc-700" : "bg-indigo-100");
                } else {
                  parentLabel.classList.add("opacity-50");
                  parentLabel.classList.remove("cursor-pointer");
                  parentLabel.classList.remove(isDark ? "hover:bg-zinc-700" : "hover:bg-indigo-50");
                }
              });
            };

            const span = document.createElement("span");
            span.className = "ml-2";
            span.innerHTML = opt;

            option.appendChild(input);
            option.appendChild(span);
            parentCard.appendChild(option);
          });

          container.appendChild(parentCard);
          conversationEl.appendChild(container);
          return;
        } else if (!activeStreamContainer || data.sequence === 0) {
          const wrapper = document.createElement("div");
          wrapper.className = `flex ${isUser ? "justify-end" : "justify-start"}`;

          activeStreamContainer = document.createElement("div");
          let classes = finalClass;
          if (data.sequence && data.sequence > 2) classes += " mt-8";

          activeStreamContainer.className = classes;
          wrapper.appendChild(activeStreamContainer);
          conversationEl.appendChild(wrapper);
        }

        document.querySelectorAll(".hint-link").forEach((link) => { link.remove(); });

        const scriptRegex = /<script\b[^>]*>([\s\S]*?)<\/script>/gi;
        const scriptBodies = [];
        const withoutScripts = data.message.replace(scriptRegex, (_, scriptBody) => {
          scriptBodies.push(scriptBody);
          return '';
        });

        activeStreamContainer.innerHTML += withoutScripts;

        setTimeout(() => {
          for (const script of scriptBodies) {
            try {
              new Function(script)();
            } catch (err) {
              console.error("Script execution failed", err);
            }
          }
        }, 50);

        hljs.highlightAll();
        hljs.initLineNumbersOnLoad();
        scrollToBottom();
      }
    }

    window.consumer.subscriptions.create(
      { channel: "ConversationChannel", id: conversationId },
      {
        received(data) {
          if(<%= Rails.env.development? %>) {
            console.log("Received data:", data);
          }
          if (data.sequence !== undefined) {
            messageQueue[data.sequence] = data;
            if(data.sequence > 6) {
              document.getElementById("signature")?.remove();
            }
            tryFlushQueue();
          } else {
            renderMessage(data); // still support non-sequenced messages
          }
        }
      }
    );
  });
</script>